@page "/event/create"

@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject SharedHelper SharedHelper
@inject CreateEventService CreateEventService

<PageTitle>New Meetup</PageTitle>



<AddOrEditEventComponent EventViewModel="_eventViewModel"
                         OnSave="CreateMeetup"
                         OnError="HandleError"
>
                         
    <ErrorMessageFragment>
        <ErrorMessageComponent ErrorMessage="@ErrorMessage"></ErrorMessageComponent>
    </ErrorMessageFragment>

</AddOrEditEventComponent>


@code {

    private EventViewModel _eventViewModel = new();

    public string ErrorMessage { get; set; } = string.Empty;

    public async Task HandleError (string msg)
    {
        ErrorMessage = msg;

        // message disappears after 7 seconds
        await Task.Delay(7000);
        ErrorMessage = string.Empty;
    }

    private async Task CreateMeetup()
    {
        CreateEventService.SetModel(_eventViewModel);

        var ValidatedDates = CreateEventService.ValidateDates();

        if (!string.IsNullOrEmpty(ValidatedDates))
        {
            ErrorMessage = ValidatedDates;

            return;
        }

        var ValidatedLocation = CreateEventService.ValidateLocation();

        if (!string.IsNullOrEmpty(ValidatedLocation))
        {
            ErrorMessage = ValidatedLocation;
       
            return;
        }

        var ValidatedEventLink = CreateEventService.ValidateEventLink();

        if (!string.IsNullOrEmpty(ValidatedEventLink))
        {
            ErrorMessage = ValidatedEventLink;
           
            return;
        }

        
        ErrorMessage = string.Empty;

        if (string.IsNullOrEmpty(ErrorMessage))
        {
            // Save Meetup
            await CreateEventService.CraeteEventAsync(_eventViewModel);

            NavigationManager.NavigateTo("/");
        }

    }
}
