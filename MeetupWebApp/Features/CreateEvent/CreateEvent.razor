

@page "/event/create"
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject SharedHelper SharedHelper
@inject CreateEventService CreateEventService
@inject EventValidationService EventValidationService
@using MeetupWebApp.Features.Events.Shared
@inherits BaseComponent
@attribute [Authorize]


<PageTitle>New Meetup</PageTitle>



<AddOrEditEventComponent EventViewModel="_eventViewModel"
                         OnSave="CreateMeetup"
                         OnError="HandleError"
>
                         
    <ErrorMessageFragment>
        <ErrorMessageComponent ErrorMessage="@ErrorMessage"></ErrorMessageComponent>
    </ErrorMessageFragment>

</AddOrEditEventComponent>


@code {

    private EventViewModel _eventViewModel = new();

    public string ErrorMessage { get; set; } = string.Empty;

    public async Task HandleError (string msg)
    {
        ErrorMessage = msg;

        // message disappears after 7 seconds
        await Task.Delay(7000);
        ErrorMessage = string.Empty;
    }

    private async Task CreateMeetup()
    {
        ErrorMessage = EventValidationService.ValidateEvent(_eventViewModel);

        if (!string.IsNullOrEmpty(ErrorMessage))
        {
            return;
        }


        if (string.IsNullOrEmpty(ErrorMessage))
        {
            _eventViewModel.OrganizerId = int.Parse(base.UserId);


            // Save Meetup
            await CreateEventService.CraeteEventAsync(_eventViewModel);

            NavigationManager.NavigateTo("/org/events");
        }

    }
}
